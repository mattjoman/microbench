#ifndef METRIC_H
#define METRIC_H

#include <stdint.h>

#include "./microbench.h"
#include "./data_processing.h"

typedef enum {

    /* counter metrics */

    COUNTER_CPU_CYCLES,
    COUNTER_REF_CPU_CYCLES,
    COUNTER_INSTRUCTIONS,
    COUNTER_CACHE_ACCESSES,
    COUNTER_CACHE_MISSES,
    COUNTER_L1_CACHE_ACCESSES,
    COUNTER_L1_CACHE_MISSES,
    COUNTER_BRANCH_INSTRUCTIONS,
    COUNTER_BRANCH_MISPREDICTIONS,
    COUNTER_STALLED_CYCLES_FRONTEND,
    COUNTER_STALLED_CYCLES_BACKEND,
    COUNTER_PAGE_FAULTS,
    COUNTER_CPU_CLOCK_NS,
    COUNTER_TASK_CLOCK_NS,
    COUNTER_ALIGNMENT_FAULTS,

    NUMBER_OF_COUNTERS,

} counter_id_t;

extern const char *counter_names[NUMBER_OF_COUNTERS];

typedef enum {

    /* ratio metrics */

    RATIO_INSTRUCTIONS_PER_CYCLE,
    RATIO_CYCLES_PER_INSTRUCTION,
    RATIO_LLC_CACHE_MISS_RATE,
    RATIO_L1_CACHE_READ_MISS_RATE,
    RATIO_BRANCH_MISPRED_RATE,
    RATIO_FE_VS_BE_STALLS,

    NUMBER_OF_RATIOS,

} ratio_id_t;

typedef struct ratio_conf {
    const char *name;
    counter_id_t numerator_id;
    counter_id_t denominator_id;
} ratio_conf_t;

extern const ratio_conf_t ratio_confs[NUMBER_OF_RATIOS];

typedef enum {
    METRIC_GRP_IPC,
    METRIC_GRP_LLC_CACHE,
    METRIC_GRP_L1_CACHE_READS,
    METRIC_GRP_BRANCH,
    METRIC_GRP_STALLED_CYCLES,
    NUMBER_OF_METRIC_GRPS,
} metric_grp_id_t;

typedef struct counter_metric {
    int id;
    uint64_t raw[MAX_BATCH_SIZE];
    uint64_agg_t agg;
} counter_metric_t;

typedef struct ratio_metric {
    int id;
    double raw[MAX_BATCH_SIZE];
    double_agg_t agg;
} ratio_metric_t;

typedef struct metric_grp {
    int id;
    int n_counters;
    int n_ratios;
    counter_id_t counter_ids[MAX_COUNTER_GRP_SIZE];
    ratio_id_t ratio_ids[MAX_RATIO_METRICS];
} metric_grp_t;

extern const metric_grp_t metric_grps[NUMBER_OF_METRIC_GRPS];

#endif
